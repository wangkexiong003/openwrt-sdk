name: build openwrt

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Openwrt Version(v24.10.4)'
        required: false
        default: 'v24.10.4'
      skipCache:
        description: 'Rebuild everything'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  buildSDK:
    name: build(${{ matrix.target }})
    runs-on: ubuntu-latest
    env:
      ALL_TARGETS: '["x86_64"]'
    strategy:
      fail-fast: true
      matrix:
        target: ${{ fromJson(env.ALL_TARGETS) }}
    outputs:
      packages: ${{ steps.targets.outputs.matrix }}

    steps:
      - &system_setup_for_openwrt
        - name: Checkout
          uses: actions/checkout@main

        - name: Prepare dependencies
          run: |
            sudo apt-get update
            sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget zstd

            sudo mkdir -p /mnt/workdir
            sudo chown $USER:$GROUPS /mnt/workdir
            echo "WORKING_DIR=/mnt/workdir" >> ${GITHUB_ENV}
            echo "TIMESTAMP=$(date +%s)"    >> ${GITHUB_ENV}

        - name: 检查服务器配置
          run: |
            echo "警告⚠"
            echo "分配的服务器性能有限，若选择的插件过多，务必注意CPU性能！"
            echo "云编译建议取消勾选Node.js及其相关插件！"
            echo "主机信息："
            uname -a
            echo -e "\n"
            echo "--------------------------CPU信息--------------------------"
            echo "CPU物理数量:$(cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l)"
            echo -e "CPU核心及版本信息：$(cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c) \n"
            echo "--------------------------内存信息--------------------------"
            echo "已安装内存详细信息："
            sudo lshw -short -C memory | grep GiB
            echo "--------------------------硬盘信息--------------------------"
            echo -e  "硬盘数量：$(ls /dev/sd* | grep -v [1-9] | wc -l) \n"
            echo "硬盘详情："
            df -Th

      - name: Restore cached build
        id: cache-restore
        if: ${{ inputs.skipCache == 'false' }}
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.WORKING_DIR }}/openwrt
          key: openwrtsdk-${{ inputs.tag }}-${{ matrix.target }}-${{ env.TIMESTAMP }}
          restore-keys: |
            openwrtsdk-${{ inputs.tag }}-${{ matrix.target }}

      - name: Check cache existence
        id: cache-check
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          if [ -d openwrt ]; then
            echo "CACHE_EXISTS=true" >> ${GITHUB_ENV}
          else
            echo "CACHE_EXISTS=false" >> ${GITHUB_ENV}
            git clone --branch ${{ inputs.tag }} --depth 1 https://github.com/openwrt/openwrt.git
          fi

      - name: Build openwrt SDK
        working-directory: ${{ env.WORKING_DIR }}/openwrt
        run: |
          cp ${GITHUB_WORKSPACE}/config/feeds4package.conf feeds.conf
          cat feeds.conf.default >> feeds.conf

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          cp ${GITHUB_WORKSPACE}/config/${{ matrix.target }} .config

          # custom building languages
          if [[ "${CACHE_EXISTS}" == "false" ]]; then
            chmod +x ${GITHUB_WORKSPACE}/update_languages.sh
            ${GITHUB_WORKSPACE}/update_languages.sh
          fi

          make defconfig
          make -j$(nproc) toolchain/install || make -j1 toolchain/install|| make -j1 toolchain/install V=s
          make -j$(nproc) package/golang/compile || make -j1 package/golang/compile || make -j1 package/golang/compile V=s
          make -j$(nproc) package/rust/compile || make -j1 package/rust/compile || make -j1 package/rust/compile V=s

      - name: Build env check
        if: ${{ always() }}
        working-directory: ${{ env.WORKING_DIR }}/openwrt
        run: |
          df -hT

      - name: Update build cache
        uses: actions/cache/save@v4
        with:
          key: ${{ steps.cache-restore.outputs.cache-primary-key }}
          path: ${{ env.WORKING_DIR }}/openwrt

      - name: Prepare build target
        id: targets
        if: matrix.target == 'x86_64'
        working-directory: ${{ env.WORKING_DIR }}/openwrt
        run: |
          node ${GITHUB_WORKSPACE}/scripts/generate_packages_matrix.js ${GITHUB_WORKSPACE}/config/feeds4package.conf

  buildTarget:
    needs: buildSDK
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix: ${{ fromJson(needs.buildSDK.outputs.packages) }}
    steps:
      <<: *system_setup_for_openwrt

      - name: Restore cached build
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.WORKING_DIR }}/openwrt
          key: openwrtsdk-always-miss
          restore-keys: |
            openwrtsdk-${{ inputs.tag }}-${{ matrix.target }}

      - name: Build
        working-directory: ${{ env.WORKING_DIR }}/openwrt
        run: |
          if [[ "${TARGET_PACKAGE}" == "" ]]; then
            cp ${GITHUB_WORKSPACE}/config/feeds4image.conf feeds.conf
          else
            cp ${GITHUB_WORKSPACE}/config/feeds4package.conf feeds.conf
          fi
          cat feeds.conf.default >> feeds.conf

          ./scripts/feeds update -a
          ./scripts/feeds install -a

          cp ${GITHUB_WORKSPACE}/config/${{ matrix.target }} .config

          make defconfig
          if [[ "${TARGET_PACKAGE}" == "" ]]; then
            chmod +x ${GITHUB_WORKSPACE}/scripts/diy_settings.sh
            ${GITHUB_WORKSPACE}/scripts/diy_settings.sh
            make -j$(nproc) || make -j1 || make -j1 V=s
          else
            chmod +x ${{ github.workspace }}/openwrt/scripts/patch.sh
            ${GITHUB_WORKSPACE}/scripts/patch.sh "${PWD}"
            make -j$(nproc) package/${TARGET_PACKAGE}/compile || make package/${TARGET_PACKAGE}/compile V=s
          fi
        env:
          TARGET_PACKAGE: ${{ matrix.package }}

      - name: Build env check
        if: ${{ always() }}
        working-directory: ${{ env.WORKING_DIR }}/openwrt
        run: |
          df -hT
